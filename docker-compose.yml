services:
  postgres-db:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_DB: lumi_rise
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d lumi_rise"]
      interval: 5s
      timeout: 5s
      retries: 10

  mqtt-broker:
    image: eclipse-mosquitto:2
    restart: unless-stopped
    ports:
      - "1883:1883"
    volumes:
      - ./docker/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log

  lumi-rise:
    build:
      network: host
      context: src/
      dockerfile: LumiRise.Api/Dockerfile
    restart: unless-stopped
    depends_on:
      postgres-db:
        condition: service_healthy
      mqtt-broker:
        condition: service_started
    environment:
      ASPNETCORE_ENVIRONMENT: Development
      ASPNETCORE_URLS: http://+:8080
      ConnectionStrings__Postgres: Host=postgres-db;Port=5432;Database=lumi_rise;Username=postgres;Password=postgres
      Mqtt__Server: mqtt-broker
      Mqtt__Port: 1883
      Mqtt__ClientId: LumiRise
      AlarmSettings__TimeZoneId: UTC
    ports:
      - "8080:8080"

  mock-dimmer-device:
    build:
      network: host
      context: src
      dockerfile: LumiRise.MockDimmerDevice/Dockerfile
    restart: unless-stopped
    depends_on:
      mqtt-broker:
        condition: service_started
    environment:
      MockDimmer__Server: mqtt-broker
      MockDimmer__Port: 1883
      MockDimmer__ClientId: mock-dimmer-device
      MockDimmer__DimmerOnOffCommand: cmnd/dimmer/power
      MockDimmer__DimmerOnOffStatus: stat/dimmer/POWER
      MockDimmer__DimmerPercentageCommand: cmnd/dimmer/dimmer
      MockDimmer__DimmerPercentageStatus: stat/dimmer/RESULT
      MockDimmer__ManualPowerTopic: mock/dimmer/manual/power
      MockDimmer__ManualBrightnessTopic: mock/dimmer/manual/brightness

volumes:
  postgres-data:
  mosquitto-data:
  mosquitto-log:
